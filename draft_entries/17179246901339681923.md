---
Title: IoTデバイス管理における"Device Shadow"という考え方
EditURL: https://blog.hatena.ne.jp/gr1m0h/gr1m0h.hatenablog.com/atom/entry/17179246901339681923
PreviewURL: https://gr1m0h.hatenablog.com/draft/entry/Nmn-LIhuLLhkgXzX_y6ywciaydI
Draft: true
---

## はじめに

IoTシステムを構築する際、デバイスの状態管理は避けて通れない課題です。デバイスがオフラインの場合でもアプリケーションから状態を参照・更新したい、デバイスとクラウド間で状態を同期したいといった要件は、多くのIoTプロジェクトで発生します。

今回は、AWS IoT Coreが提供する**Device Shadow**という仕組みについて説明します。Device Shadowは「デバイスの影」をクラウド上に作成することで、これらの課題を解決するアプローチです。

なお、本記事では以下の用語を次のように定義しています。

- **デバイス**: センサーやアクチュエータを備えた物理的なIoT機器
- **クラウド**: AWS IoT Coreを中心としたバックエンドシステム
- **アプリケーション**: クラウド上でデバイスを制御・監視するサービス

## Device Shadowとは

Device Shadowは、AWS IoT Coreが提供するデバイス状態管理の仕組みです。物理デバイスの「影（Shadow）」をクラウド上に作成し、デバイスがオフラインの場合でもアプリケーションからデバイスの状態を参照・更新できるようにします。

https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html

Device Shadowの核となる概念は、**desired**（期待される状態）と**reported**（報告された状態）の分離です。アプリケーションはdesiredに「こうあってほしい」という状態を書き込み、デバイスはreportedに「実際の現在状態」を書き込みます。この2つの差分（delta）をAWS IoT Coreが自動的に計算し、デバイスに通知します。

以下は『AWS IoT Developer Guide』からの引用です。

> A device's shadow is a JSON document that is used to store and retrieve current state information for a device.

Device Shadowは単なるデータストアではなく、デバイスとクラウド間の状態同期を実現するためのステートマシンとして機能します。

## Device Shadowの構造

Device ShadowはJSON形式で表現されます。以下の図はDevice Shadowの基本構造を簡略化したものです。

https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-document.html

```
┌─────────────────────────────────────────────┐
│              Device Shadow                   │
├─────────────────────────────────────────────┤
│  state                                       │
│  ├── desired   ← アプリケーションが設定      │
│  │   └── { "power": "on", "temp": 25 }      │
│  ├── reported  ← デバイスが報告              │
│  │   └── { "power": "off", "temp": 22 }     │
│  └── delta     ← 自動計算される差分          │
│      └── { "power": "on", "temp": 25 }      │
├─────────────────────────────────────────────┤
│  metadata                                    │
│  └── 各属性のタイムスタンプ                  │
├─────────────────────────────────────────────┤
│  version                                     │
│  └── 楽観的ロック用のバージョン番号          │
└─────────────────────────────────────────────┘
```

Device Shadowの実際のJSONドキュメントは以下のようになります。

```json
{
  "state": {
    "desired": {
      "power": "on",
      "temperature": 25
    },
    "reported": {
      "power": "off",
      "temperature": 22
    },
    "delta": {
      "power": "on",
      "temperature": 25
    }
  },
  "metadata": {
    "desired": {
      "power": { "timestamp": 1234567890 },
      "temperature": { "timestamp": 1234567890 }
    },
    "reported": {
      "power": { "timestamp": 1234567880 },
      "temperature": { "timestamp": 1234567880 }
    }
  },
  "version": 10,
  "timestamp": 1234567890
}
```

この構造により、「アプリケーションが何を期待しているか」「デバイスが実際にどうなっているか」「その差分は何か」を常に把握できます。

## 他のアプローチとの比較: LwM2M

IoTデバイスの状態管理には、Device Shadow以外にもさまざまなアプローチがあります。ここでは、OMA（Open Mobile Alliance）が標準化した**LwM2M**（Lightweight M2M）との比較を通じて、Device Shadowの特徴を整理します。

LwM2Mは、IoTデバイス管理のための軽量プロトコルです。リソースモデルを通じてデバイスの状態を表現し、CoAP（Constrained Application Protocol）をベースとした効率的な通信を実現します。Observe/Notifyという仕組みにより、サーバーがデバイスの状態変化を監視できます。

https://www.openmobilealliance.org/release/LightweightM2M/

以下の図は両者のアプローチの違いを整理したものです。

```
┌─────────────────────────────────────────────────────────────┐
│                    デバイス状態管理                          │
├────────────────────────┬────────────────────────────────────┤
│       LwM2M            │         Device Shadow              │
├────────────────────────┼────────────────────────────────────┤
│ プロトコルレベル        │ サービスレベル                     │
│ リソースモデル          │ JSONドキュメント                   │
│ Observe/Notify         │ desired/reported/delta             │
│ CoAP/UDP               │ MQTT/HTTPS                         │
│ 標準化団体(OMA)        │ AWS独自                            │
└────────────────────────┴────────────────────────────────────┘
```

考えられる使い分けは以下のとおりです。

- **LwM2M**: 標準化されたプロトコルが必要な場合、マルチベンダー環境、通信帯域が極めて限られる環境
- **Device Shadow**: AWSエコシステムを活用する場合、柔軟なデータ構造が必要な場合、既存のMQTT実装を活かしたい場合

個人的には、どちらが優れているということではなく、システム要件に応じて適切に選択することが重要だと考えています。

## Device Shadowの操作

Device Shadowの操作は、MQTTトピックまたはHTTPS APIを通じて行います。ここでは、より一般的に使用されるMQTTトピックについて説明します。

https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-mqtt.html

### 1. 状態の更新

デバイスまたはアプリケーションがDevice Shadowを更新する場合、以下のトピックにパブリッシュします。

```
$aws/things/{thingName}/shadow/update
```

更新リクエストの例は以下のとおりです。

```json
{
  "state": {
    "reported": {
      "power": "on",
      "temperature": 24
    }
  }
}
```

更新が成功すると、以下のトピックにレスポンスがパブリッシュされます。

```
$aws/things/{thingName}/shadow/update/accepted
```

### 2. 状態の取得

現在のDevice Shadow全体を取得するには、以下のトピックに空のメッセージをパブリッシュします。

```
$aws/things/{thingName}/shadow/get
```

レスポンスは以下のトピックで受信します。

```
$aws/things/{thingName}/shadow/get/accepted
```

### 3. delta通知の購読

デバイスがdesiredとreportedの差分を受け取るには、以下のトピックを購読します。

```
$aws/things/{thingName}/shadow/update/delta
```

アプリケーションがdesiredを更新し、reportedと差分がある場合、このトピックに差分情報が自動的にパブリッシュされます。

## 実装例

Goを使用したDevice Shadow操作の実装例を紹介します。以下のコードは、デバイス側でdelta通知を受信し、状態を同期する基本的なパターンです。

REST APIを使用する場合は以下のドキュメントを参照してください。

https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-rest-api.html

デバイス側での実装パターンについては以下が参考になります。

https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-comms-device.html

```go
package main

import (
	"encoding/json"
	"fmt"
	"log"

	mqtt "github.com/eclipse/paho.mqtt.golang"
)

type ShadowState struct {
	State struct {
		Desired  map[string]interface{} `json:"desired,omitempty"`
		Reported map[string]interface{} `json:"reported,omitempty"`
		Delta    map[string]interface{} `json:"delta,omitempty"`
	} `json:"state"`
	Version int `json:"version"`
}

func main() {
	thingName := "my-iot-device"

	opts := mqtt.NewClientOptions()
	opts.AddBroker("ssl://xxxxx.iot.ap-northeast-1.amazonaws.com:8883")
	opts.SetClientID(thingName)
	// TLS設定は省略

	client := mqtt.NewClient(opts)
	if token := client.Connect(); token.Wait() && token.Error() != nil {
		log.Fatal(token.Error())
	}

	// delta通知を購読
	deltaTopic := fmt.Sprintf("$aws/things/%s/shadow/update/delta", thingName)
	client.Subscribe(deltaTopic, 1, func(c mqtt.Client, m mqtt.Message) {
		var delta ShadowState
		if err := json.Unmarshal(m.Payload(), &delta); err != nil {
			log.Printf("Failed to parse delta: %v", err)
			return
		}

		// deltaに基づいてデバイス状態を更新
		handleDelta(delta.State.Delta)

		// 更新完了後、reportedを更新
		reportState(client, thingName, delta.State.Delta)
	})

	select {}
}

func handleDelta(delta map[string]interface{}) {
	// 実際のデバイス制御ロジック
	for key, value := range delta {
		log.Printf("Applying delta: %s = %v", key, value)
	}
}

func reportState(client mqtt.Client, thingName string, state map[string]interface{}) {
	updateTopic := fmt.Sprintf("$aws/things/%s/shadow/update", thingName)

	payload := ShadowState{}
	payload.State.Reported = state

	data, _ := json.Marshal(payload)
	client.Publish(updateTopic, 1, false, data)
}
```

この実装のポイントは以下のとおりです。

- delta通知を購読することで、変更があった属性のみを効率的に処理できる
- 状態更新後にreportedを更新することで、desired/reported間の同期が完了する
- 楽観的ロック（version）を使用することで、競合状態を検出できる

## Named Shadow

AWS IoT Coreでは、1つのデバイスに対して複数のDevice Shadowを作成できます。これを**Named Shadow**と呼びます。

Named Shadowが有用なユースケースは以下のとおりです。

- **機能ごとの分離**: 電源管理、センサー設定、ネットワーク設定を別々のShadowで管理
- **アクセス制御の細分化**: IAMポリシーでShadowごとにアクセス権限を設定
- **更新頻度の最適化**: 頻繁に更新される状態と、まれに更新される設定を分離

Named Shadowのトピック構造は以下のようになります。

```
$aws/things/{thingName}/shadow/name/{shadowName}/update
$aws/things/{thingName}/shadow/name/{shadowName}/get
$aws/things/{thingName}/shadow/name/{shadowName}/delete
```

以下は、機能ごとにNamed Shadowを分離した例です。

```
デバイス: smart-thermostat-001
├── Shadow: power
│   └── { "state": { "reported": { "on": true } } }
├── Shadow: temperature
│   └── { "state": { "reported": { "current": 24, "target": 25 } } }
└── Shadow: network
    └── { "state": { "reported": { "ssid": "home-wifi", "rssi": -45 } } }
```

## 運用上の考慮事項

Device Shadowを本番環境で運用する際に考慮すべき点を整理します。

https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-data-flow.html

### 1. サイズ制限

Device Shadowドキュメントには8KBのサイズ制限があります。大量のセンサーデータを扱う場合は、Device Shadowではなく、Amazon Kinesis Data StreamsやAmazon Timestreamへの直接送信を検討する必要があります。

### 2. 更新頻度

Device Shadowは1秒あたり最大10回の更新に対応しています。高頻度の更新が必要な場合は、デバイス側でバッファリングするか、別のデータパスを検討します。

### 3. オフライン時の挙動

デバイスがオフラインの間にdesiredが複数回更新された場合、デバイスが再接続した時点で最新のdeltaのみが通知されます。中間状態が重要な場合は、別途ログを残す仕組みが必要です。

### 4. バージョン管理

楽観的ロックのためのversion属性を活用することで、競合更新を検出できます。ただし、競合時のリトライ処理はアプリケーション側で実装する必要があります。

## ハンズオン: Device Shadowを実際に操作する

ここでは、AWSコンソールとAWS CLIを使用してDevice Shadowの動作を実際に確認する手順を紹介します。この手順を通じて、desired/reported/deltaの挙動を体験できます。

https://docs.aws.amazon.com/iot/latest/developerguide/using-device-shadows.html

### 1. 事前準備

以下のリソースが必要です。

- AWSアカウント
- AWS CLIがインストールされた環境
- 適切なIAM権限（`iot:*` および `iot-data:*`）

AWS CLIのセットアップについては以下を参照してください。

https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

### 2. IoT Thingの作成

まず、AWS CLIでIoT Thingを作成します。

```bash
# Thingの作成
aws iot create-thing --thing-name test-device-shadow

# 作成確認
aws iot describe-thing --thing-name test-device-shadow
```

### 3. Device Shadowの作成と更新

Device Shadowは明示的に作成する必要があります。`update-thing-shadow`コマンドでShadowを作成・更新します。

https://docs.aws.amazon.com/cli/latest/reference/iot-data/update-thing-shadow.html

```bash
# IoT Coreのエンドポイントを取得
IOT_ENDPOINT=$(aws iot describe-endpoint --endpoint-type iot:Data-ATS --query 'endpointAddress' --output text)

# Device Shadowの作成（reportedを設定）
aws iot-data update-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  --cli-binary-format raw-in-base64-out \
  --payload '{"state":{"reported":{"power":"off","temperature":22}}}' \
  /dev/stdout | jq .
```

出力例は以下のようになります。

```json
{
  "state": {
    "reported": {
      "power": "off",
      "temperature": 22
    }
  },
  "metadata": {
    "reported": {
      "power": { "timestamp": 1735776000 },
      "temperature": { "timestamp": 1735776000 }
    }
  },
  "version": 1,
  "timestamp": 1735776000
}
```

### 4. Device Shadowの取得

https://docs.aws.amazon.com/cli/latest/reference/iot-data/get-thing-shadow.html

```bash
# Device Shadowの取得
aws iot-data get-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  /dev/stdout | jq .
```

### 5. desiredの設定とdeltaの確認

アプリケーション側からdesiredを設定し、deltaが生成されることを確認します。

```bash
# desiredを設定（powerをonに変更）
aws iot-data update-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  --cli-binary-format raw-in-base64-out \
  --payload '{"state":{"desired":{"power":"on","temperature":25}}}' \
  /dev/stdout | jq .
```

この時点でDevice Shadowを取得すると、deltaが生成されていることが確認できます。

```bash
aws iot-data get-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  /dev/stdout | jq .
```

出力例は以下のようになります。

```json
{
  "state": {
    "desired": {
      "power": "on",
      "temperature": 25
    },
    "reported": {
      "power": "off",
      "temperature": 22
    },
    "delta": {
      "power": "on",
      "temperature": 25
    }
  },
  "version": 2
}
```

`delta`にdesiredとreportedの差分が自動的に計算されています。

### 6. reportedの更新によるdelta解消

デバイスがdesiredの状態を反映した後、reportedを更新するとdeltaが解消されます。

```bash
# reportedをdesiredに合わせて更新
aws iot-data update-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  --cli-binary-format raw-in-base64-out \
  --payload '{"state":{"reported":{"power":"on","temperature":25}}}' \
  /dev/stdout | jq .
```

再度Device Shadowを取得すると、deltaが空になっていることが確認できます。

### 7. AWSコンソールでの確認

AWS IoT Coreコンソールでも同様の操作が可能です。

1. AWS IoT Coreコンソールを開く
2. 「管理」→「モノ」から対象のThingを選択
3. 「Device Shadow」タブでShadowドキュメントを確認・編集

また、「テスト」→「MQTTテストクライアント」でShadowトピックを購読することで、リアルタイムの変更を確認できます。

```
$aws/things/test-device-shadow/shadow/update/accepted
$aws/things/test-device-shadow/shadow/update/delta
$aws/things/test-device-shadow/shadow/update/documents
```

### 8. クリーンアップ

検証が終わったらリソースを削除します。

```bash
# Device Shadowの削除
aws iot-data delete-thing-shadow \
  --endpoint-url https://${IOT_ENDPOINT} \
  --thing-name test-device-shadow \
  /dev/stdout

# Thingの削除
aws iot delete-thing --thing-name test-device-shadow
```

## Terraformによる設定例

インフラストラクチャをコードで管理する場合、TerraformでDevice Shadowの関連リソースを定義できます。以下は基本的な設定例です。

```hcl
# IoT Thing の作成
resource "aws_iot_thing" "device" {
  name = "smart-thermostat-001"

  attributes = {
    device_type = "thermostat"
    location    = "living-room"
  }
}

# IoT Policy の作成
resource "aws_iot_policy" "device_policy" {
  name = "smart-thermostat-policy"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect   = "Allow"
        Action   = ["iot:Connect"]
        Resource = "arn:aws:iot:ap-northeast-1:*:client/${iot:Connection.Thing.ThingName}"
      },
      {
        Effect = "Allow"
        Action = [
          "iot:Publish",
          "iot:Receive"
        ]
        Resource = [
          "arn:aws:iot:ap-northeast-1:*:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/*"
        ]
      },
      {
        Effect   = "Allow"
        Action   = ["iot:Subscribe"]
        Resource = [
          "arn:aws:iot:ap-northeast-1:*:topicfilter/$aws/things/${iot:Connection.Thing.ThingName}/shadow/*"
        ]
      }
    ]
  })
}

# Thing と Policy の紐付け用証明書
resource "aws_iot_certificate" "device_cert" {
  active = true
}

resource "aws_iot_thing_principal_attachment" "attachment" {
  principal  = aws_iot_certificate.device_cert.arn
  thing      = aws_iot_thing.device.name
}

resource "aws_iot_policy_attachment" "policy_attachment" {
  policy = aws_iot_policy.device_policy.name
  target = aws_iot_certificate.device_cert.arn
}
```

このTerraform設定のポイントは以下のとおりです。

- IoTポリシーで `${iot:Connection.Thing.ThingName}` を使用し、デバイスが自身のShadowのみにアクセスできるよう制限
- 証明書ベースの認証を使用し、セキュアな接続を確保
- Named Shadowを使用する場合は、Resourceパターンを適宜調整

## さいごに

AWS IoT CoreのDevice Shadowについて紹介しました。Device Shadowは、desired/reported/deltaという3つの状態を通じて、デバイスとクラウド間の状態同期を実現する仕組みです。

Device ShadowはAWSエコシステムとの統合が容易で、柔軟なJSONスキーマを採用している点が特徴です。一方で、マルチベンダー環境や標準プロトコルが求められる場合は、LwM2Mのような標準化されたプロトコルも選択肢になります。どちらを採用するかは、システム要件やチームのスキルセットなどを考慮して判断する必要があると考えています。

形になったタイミングで、LwM2Mの詳細やDevice ShadowとAWS IoT Eventsを組み合わせた状態遷移管理についてもブログでお話しできればと思います。

## 参考資料

本記事で参照した公式ドキュメントをまとめます。

**AWS IoT Core Device Shadow**

- AWS IoT Device Shadow service
  - https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html
- Device Shadow service documents
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-document.html
- Device Shadow MQTT topics
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-mqtt.html
- Device Shadow REST API
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-rest-api.html
- Interacting with shadows
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-data-flow.html
- Using shadows in devices
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-comms-device.html
- Using shadows in apps and services
  - https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-comms-app.html
- Simulating Device Shadow service communications
  - https://docs.aws.amazon.com/iot/latest/developerguide/using-device-shadows.html
- Tutorial: Interacting with Device Shadow
  - https://docs.aws.amazon.com/iot/latest/developerguide/interact-lights-device-shadows.html

**AWS CLI**

- get-thing-shadow
  - https://docs.aws.amazon.com/cli/latest/reference/iot-data/get-thing-shadow.html
- update-thing-shadow
  - https://docs.aws.amazon.com/cli/latest/reference/iot-data/update-thing-shadow.html

**LwM2M**

- OMA LightweightM2M
  - https://www.openmobilealliance.org/release/LightweightM2M/
