---
Title: TrivyとDependabotで脆弱性チェックを行う
EditURL: https://blog.hatena.ne.jp/gr1m0h/gr1m0h.hatenablog.com/atom/entry/17179246901339642063
PreviewURL: https://gr1m0h.hatenablog.com/draft/entry/0cafSF1hJ28hk_-9gRNz6FZ3bac
---

## はじめに

CI/CDパイプラインで脆弱性スキャンを回す構成を考えていて、TrivyとDependabotを組み合わせて設定してみました。

本記事では、GitHub ActionsでTrivyとDependabotを使った脆弱性チェックの設定を紹介します。Go + Dockerを対象にしていますが、他の言語でも応用できる内容です。

## TrivyとDependabotの役割

TrivyとDependabotはどちらも脆弱性を検出できますが、役割が違います。

**Trivy**はAqua Security社が開発するOSSの脆弱性スキャナーです。依存関係の脆弱性だけでなく、コンテナイメージの脆弱性、IaCの設定ミス、シークレットの漏洩も検出できます。スキャン結果をSARIF形式で出力してGitHub Security Tabに統合できるのが便利です。

[https://aquasecurity.github.io/trivy/:embed:cite]

**Dependabot**はGitHubに統合された依存関係管理ツールです。脆弱性の検出だけでなく、修正のためのPRを自動生成してくれます。GitHub Actionsの依存関係にも対応しているので、アクションのバージョン更新も自動化できます。

[https://docs.github.com/en/code-security/dependabot:embed:cite]

両方を使うことで、Trivyで包括的にスキャンしつつ、Dependabotで修正PRを自動生成する運用ができます。

## Dependabotの設定

Dependabotの設定ファイルは `.github/dependabot.yml` に配置します。Go、GitHub Actions、Dockerに対応した設定はこんな感じです。

```yaml
version: 2
updates:
  # GitHub Actions の依存関係更新
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    # マイナー・パッチ更新をグループ化してPR数を削減
    groups:
      github-actions:
        patterns:
          - "*"
    commit-message:
      prefix: "chore(deps):"
    labels:
      - "dependencies"
      - "github-actions"

  # Go モジュールの依存関係更新
  - package-ecosystem: "gomod"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    # セキュリティアップデートは個別、それ以外はグループ化
    groups:
      go-minor-patch:
        patterns:
          - "*"
        update-types:
          - "minor"
          - "patch"
    commit-message:
      prefix: "chore(deps):"
    labels:
      - "dependencies"
      - "go"

  # Docker イメージの依存関係更新
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    commit-message:
      prefix: "chore(deps):"
    labels:
      - "dependencies"
      - "docker"
```

ポイントをいくつか解説します。

### 1. スケジュール設定

`schedule` で更新チェックの頻度を設定しています。`daily` ではなく `weekly` にしているのは、後述するGroups機能との組み合わせを考えたからです。毎日チェックすると週の途中でPRが作られて、その後も追加の更新が検出されてしまいます。週次にすれば、1週間分の更新をまとめて1つのPRにできます。

### 2. Groups機能

`groups` は複数の依存関係を1つのPRにまとめる機能で、個人的に一番嬉しい機能です。マイナーアップデートやパッチアップデートを個別にPRとして作成すると、PRが大量になってレビューが大変になります。`patterns` で対象パッケージを、`update-types` で対象とする更新タイプを指定します。

### 3. コミットメッセージとラベル

`commit-message` でConventional Commitsに準拠したプレフィックスを設定して、`labels` で自動的にラベルを付与しています。PRのフィルタリングや自動マージの条件設定がしやすくなります。

## Trivyの設定

Trivyの設定はGitHub Actionsワークフローとして `.github/workflows/trivy-scan.yml` に配置します。今回は4種類のスキャンを実行する構成にしました。

1. リポジトリスキャン（依存関係の脆弱性）
2. IaCスキャン（Dockerfile、Kubernetesの設定ミス）
3. シークレットスキャン（認証情報の漏洩）
4. コンテナイメージスキャン

まずワークフローの共通設定です。

```yaml
name: Security Scan with Trivy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # 毎週月曜日の午前9時（JST）に定期スキャン
    - cron: "0 0 * * 1"
  workflow_dispatch: # 手動実行も可能

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/go-test-server

permissions:
  contents: read
  security-events: write
  packages: write
```

トリガーはpushとpull_requestに加えて、週次の定期スキャン（schedule）と手動実行（workflow_dispatch）を設定しています。定期スキャンはコードに変更がなくても新しいCVEが公開されれば脆弱性が検出されるので、入れておくと安心です。

なお、以降のコード例ではアクションをコミットハッシュでピン留めしています（例：`actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1`）。タグはいつでも書き換え可能なので、悪意のあるコードがタグに紐づけられるリスクがあります。コミットハッシュでピン留めすることで、サプライチェーン攻撃のリスクを軽減できます。

### 1. リポジトリスキャン

アプリケーションの依存関係に含まれる脆弱性を検出します。

```yaml
repo-scan:
  name: Repository Vulnerability Scan
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Run Trivy vulnerability scanner (filesystem mode)
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        scan-type: "fs"
        scan-ref: "."
        trivy-config: trivy.yaml
        format: "sarif"
        output: "trivy-repo-results.sarif"
        # vuln スキャナーのみ使用（他はジョブで分離）
        scanners: "vuln"

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
      if: always()
      with:
        sarif_file: "trivy-repo-results.sarif"
        category: "trivy-repo"
```

ポイントは以下です。

- `scan-type: "fs"`: ファイルシステムモードでスキャン
- `trivy-config: trivy.yaml`: 設定ファイルを指定（CI/CDとローカルで同じ設定を使える）
- `format: "sarif"`: GitHub Security Tabに統合するためSARIF形式で出力
- `scanners: "vuln"`: 脆弱性スキャンのみ（他のスキャンは別ジョブで実行）

`trivy.yaml` で `ignore-unfixed: true` を設定して、修正バージョンがリリースされていない脆弱性を除外しています。対応できない脆弱性がノイズになるのを防ぐためです。

### 2. IaCスキャン

DockerfileやKubernetes Manifestのセキュリティ不備を検出します。

```yaml
iac-scan:
  name: IaC Configuration Scan
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Run Trivy scanner (config mode)
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        scan-type: "config"
        scan-ref: "."
        trivy-config: trivy.yaml
        format: "sarif"
        output: "trivy-iac-results.sarif"
        # misconfig スキャナーのみ使用
        scanners: "misconfig"

    - name: Upload Trivy IaC scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
      if: always()
      with:
        sarif_file: "trivy-iac-results.sarif"
        category: "trivy-iac"
```

### 3. シークレットスキャン

ソースコード内に含まれる認証情報やAPIキーを検出します。

```yaml
secret-scan:
  name: Secret Scan
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0 # 全履歴を取得してシークレットを検出

    - name: Run Trivy secret scanner
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        scan-type: "fs"
        scan-ref: "."
        trivy-config: trivy.yaml
        format: "sarif"
        output: "trivy-secret-results.sarif"
        scanners: "secret"

    - name: Upload Trivy secret scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
      if: always()
      with:
        sarif_file: "trivy-secret-results.sarif"
        category: "trivy-secret"
```

`fetch-depth: 0` でGitの全履歴を取得しています。一度コミットしたシークレットは履歴を書き換えない限り残り続けるので、全履歴をスキャンするのが大事です。

### 4. コンテナイメージスキャン

ビルドしたDockerイメージに含まれる脆弱性を検出します。

```yaml
container-scan:
  name: Build and Scan Container Image
  runs-on: ubuntu-latest
  # mainブランチへのpushまたは手動実行時のみ
  if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

    - name: Log in to Container registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,prefix=
          type=ref,event=branch
          type=semver,pattern={{version}}

    - name: Build and push Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # SBOMとProvenanceを生成（サプライチェーンセキュリティ）
        sbom: true
        provenance: true

    - name: Run Trivy vulnerability scanner on container image
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main"
        trivy-config: trivy.yaml
        format: "sarif"
        output: "trivy-image-results.sarif"
        scanners: "vuln"

    - name: Upload Trivy container scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
      if: always()
      with:
        sarif_file: "trivy-image-results.sarif"
        category: "trivy-container"

    # テーブル形式でも出力（PR上でのレビュー用）
    - name: Run Trivy scanner (table output for review)
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main"
        trivy-config: trivy.yaml
        scanners: "vuln"
```

`docker/build-push-action` では `sbom: true` と `provenance: true` を指定しています。SBOM（Software Bill of Materials）と来歴情報が自動生成されて、コンテナイメージに含まれるソフトウェア部品を追跡できるようになります。

`cache-from` と `cache-to` でGitHub Actionsのキャッシュを使ってビルド時間を短縮しています。テーブル形式での出力も追加しているので、ログで結果を確認しやすいです。

## SBOM生成

SBOMはソフトウェアに含まれるコンポーネントの一覧で、サプライチェーンセキュリティの観点で最近注目されています。

TrivyでSBOMを生成するジョブも追加しました。

```yaml
sbom:
  name: Generate SBOM
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Generate SBOM with Trivy
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        scan-type: "fs"
        scan-ref: "."
        trivy-config: trivy.yaml
        format: "cyclonedx"
        output: "sbom.json"

    - name: Upload SBOM as artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: sbom
        path: sbom.json
        retention-days: 30
```

CycloneDX形式でSBOMを生成してGitHub Actionsのアーティファクトとして保存しています。

## ローカルでのスキャン

CI/CDだけでなくローカルでもスキャンできると便利です。Trivyの設定ファイル `trivy.yaml` を用意すれば、CI/CDとローカルで同じ設定を使えます。

```yaml
# Trivy configuration file
# https://aquasecurity.github.io/trivy/latest/docs/references/configuration/config-file/
# CI/CD とローカルで共通の設定

# タイムアウト設定
timeout: 10m

# スキャン設定
scan:
  # スキャナーの種類（ジョブごとに上書き可能）
  scanners:
    - vuln # 脆弱性スキャン
    - misconfig # IaC設定ミススキャン
    - secret # シークレットスキャン
    - license # ライセンスチェック

  # スキップするディレクトリ
  skip-dirs:
    - .git
    - vendor
    - node_modules
    - testdata

  # スキップするファイル
  skip-files:
    - "**/*_test.go"

# 重要度のしきい値
severity:
  - CRITICAL
  - HIGH
  - MEDIUM

# 修正済みの脆弱性のみ報告
vulnerability:
  ignore-unfixed: true
  type:
    - os
    - library

# 設定ミススキャン設定
misconfiguration:
  # スキャン対象のIaCタイプ
  scanners:
    - dockerfile
    - kubernetes

# 出力設定（ローカル用、CI/CDでは上書きされる）
format: table

# 無視設定
ignore-file: .trivyignore

# ライセンス設定
license:
  # 許可するライセンス
  ignored:
    - MIT
    - Apache-2.0
    - BSD-2-Clause
    - BSD-3-Clause
    - ISC

# データベース設定
db:
  # スキャン前にDBを更新
  skip-update: false
```

ローカルでのスキャンコマンドはこんな感じです。`--config trivy.yaml` を指定すればCI/CDと同じ設定でスキャンできます。

```bash
# ファイルシステムスキャン
trivy fs --config trivy.yaml .

# Dockerイメージスキャン
docker build -t go-test-server:local .
trivy image --config trivy.yaml go-test-server:local

# シークレットスキャン
trivy fs --config trivy.yaml --scanners secret .

# SBOM生成
trivy fs --config trivy.yaml --format cyclonedx --output sbom.json .
```

## さいごに

TrivyとDependabotを使った脆弱性チェックの設定を紹介しました。

依存関係の脆弱性、IaCの設定ミス、シークレットの漏洩、コンテナイメージの脆弱性を包括的にスキャンできるので、導入しておくと安心感があります。設定自体はそこまで複雑ではないので、ぜひ試してみてください。
