---
Title: IoT基礎知識としてのLwM2M
EditURL: https://blog.hatena.ne.jp/gr1m0h/gr1m0h.hatenablog.com/atom/entry/17179246901339655653
PreviewURL: https://gr1m0h.hatenablog.com/draft/entry/JC4ZfKyJh8K1GGVRMXczIgHvlVI
Draft: true
---

## はじめに

学生時代からIoTに関わることが多く、現職への転職で初めてIoTに直接関わらない仕事をすることになりました。ただ、IoTは今後も自分の強みとして関わり続けたいと思っています。

そこで、以前調べたLwM2MというIoTデバイス管理のプロトコルについて改めて整理し直すことにしました。過去に書いた記事は以下です。

[https://zenn.dev/gr1m0h/articles/gr1m0h-20231217:embed:cite]

前回の記事ではLwM2Mの概要とオブジェクト・リソースの基本的な読み方について触れました。今回はアーキテクチャやセキュリティ、MQTTとの比較なども含めて、より体系的にまとめます。

## LwM2Mとは

LwM2M（Lightweight Machine to Machine）は、OMA SpecWorks（旧Open Mobile Aliance）が策定したIoTデバイス管理とサービス実現のためのアプリケーション層プロトコルです。「えるだぶるりゅーえむつーえむ」と読みます。

[https://www.openmobilealliance.org/specifications/lwm2m/:embed:cite]

LwM2Mは、計算能力やメモリが限られたリソース制約のあるデバイス向けに設計されています。ファームウェア更新（FOTA: Firmware Over The Air）、リモート診断、接続管理、セキュリティ資格情報のプロビジョニングなど、IoTデバイスのライフサイクル全体を管理する機能を提供しています。

### バージョンの変遷

LwM2Mは継続的に進化しており、主要なバージョンは以下の通りです。

- LwM2M 1.0（2017/2）: 初版リリース。CoAP/UDPベースの基本機能を提供。
- LwM2M 1.1（2018/6）：TCP/TLSサポート、PKI対応強化、SenML JSONサポート、OSCOREによるアプリケーション層セキュリティ
- LwM2M 1.2（2020/11）：MQTTおよびHTTPトランスポート、LwM2M CBOR、TLS/DTLS 1.3、ゲートウェイ機能、ブートストラップ最適化

各バージョンの仕様書は以下から取得できます。

[https://www.openmobilealliance.org/specifications/lwm2m/releases/:embed:cite]

現在のIoTプラットフォームの多くはLwM2M 1.1をサポートしており、1.2の機能も順次対応が進んでいます。LwM2M 1.2のCore仕様書は以下です。

[https://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Core-V1_2-20201110-A.html:embed:cite]

## アーキテクチャ

LwM2Mのアーキテクチャは、3つの主要コンポーネントで構成されています。

### 1. LwM2Mクライアント

IoTデバイス上で動作するソフトウェアエンティティです。デバイスのリソースを管理し、サーバーとの通信を担当します。クライアントは、デバイスがサポートするオブジェクトとリソースをサーバーに公開し、テレメトリデータの送信や管理コマンドの受信を行います。

代表的なオープンソースのLwM2Mクライアント実装には以下があります。

- Anjay（AVSystem）: C言語で実装された高機能なクライアント
  - https://github.com/AVSystem/Anjay-doc
  - https://avsystem.github.io/Anjay-doc/
- Zephyr LwM2M Client: Zephyr RTOSに統合されたクライアント
  - https://docs.zephyrproject.org/latest/connectivity/networking/api/lwm2m.html
- Wakaama（Eclipse Foundation）: C言語のリファレンス実装
  - https://github.com/eclipse-wakaama/wakaama

### 2. LwM2Mサーバー

クラウドまたはローカルネットワーク上で動作し、複数のLwM2Mクライアントを管理します。デバイスのモニタリング、設定変更、ファームウェア更新のスケジューリングなどを行います。

主要なLwM2Mサーバープラットフォームには以下があります。

- Coiote IoT Device Management（AVSystem）
  - https://www.avsystem.com/products/coiote-iot-device-management-platform/
- SORACOM Inventory
  - https://soracom.jp/services/inventory/
- Cumulocity IoT
  - https://cumulocity.com/docs/protocol-integration/lwm2m/
- Leshan（Eclipse Foundation）: Javaのリファレンス実装
  - https://github.com/eclipse-leshan/leshan

### 3. LwM2Mブートストラップサーバー

デバイスの初期設定を担当するオプションのコンポーネントです。セキュリティ資格情報、サーバー接続情報、アクセス制御リストなどをデバイスにプロビジョニングします。

ブートストラップには3つの方式があります。

- **ファクトリーブートストラップ**: 製造時にデバイスに設定を事前書き込み
- **クライアント起動ブートストラップ**: デバイスがブートストラップサーバーに接続して設定を取得
- **サーバー起動ブートストラップ**: サーバーからデバイスに設定をプッシュ

ブートストラップサーバーの使用は任意ですが、セキュリティ資格情報の更新やサーバー移行などを考慮すると、実運用では推奨されます。

## 4つのインターフェース

LwM2Mでは、クライアントとサーバー間の通信に4つのインターフェースが定義されています。詳細は仕様書の「6.Interfaces」セクションに記載されています。

[https://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Core-V1_2-20201110-A.html#6-Interfaces:embed:cite]

### 1. Bootstrap Interface

デバイスの初期設定を行うインターフェースです。LwM2Mブートストラップサーバーがクライアントにセキュリティ資格情報やサーバー接続情報をプロビジョニングします。

主な操作は以下の通りです。

- **Bootstrap-Request**: クライアントがブートストラップサーバーにプロビジョニングを要求
- **Bootstrap-Discover**: サーバーがクライアントのデータモデルを取得
- **Bootstrap-Write**: サーバーがクライアントに設定を書き込み
- **Bootstrap-Delete**: サーバーがクライアントのオブジェクトインスタンスを削除
- **Bootstrap-Finish**: プロビジョニング完了の通知

### 2. Client Registration Interface

クライアントがサーバーに自身の存在と機能を通知するインターフェースです。

主な操作は以下の通りです。

- **Register**: クライアントがサーバーに登録し、サポートするオブジェクトを通知
- **Update**: 登録情報の更新（IPアドレス変更、ライフタイム延長など）
- **De-register**: クライアントの登録解除

登録時には、クライアントのエンドポイント名、ライフタイム、バインディングモード、サポートするオブジェクトのリストなどが送信されます。

### 3. Device Management and Service Enablement Interface

サーバーがクライアントのリソースにアクセスするためのメインインターフェースです。

主な操作は以下の通りです。

- **Read**: リソースの値を取得
- **Write**: リソースに値を書き込み
- **Execute**: 実行可能なリソースを呼び出し（例: デバイス再起動）
- **Create**: オブジェクトインスタンスを作成
- **Delete**: オブジェクトインスタンスを削除
- **Discover**: サポートするオブジェクトとリソースのリストを取得
- **Write-Attributes**: 通知属性を設定

LwM2M 1.1以降では、複数のリソースを一度に操作できる **Composite操作**（Read-Composite、Write-Composite、Observe-Composite）も追加されています。

### 4. Information Reporting Interface

クライアントからサーバーへの定期的またはイベントベースのデータ報告を行うインターフェースです。CoAPのObserve拡張（RFC 7641）に基づいています。

[https://datatracker.ietf.org/doc/html/rfc7641:embed:cite]

主な操作は以下の通りです。

- **Observe**: サーバーがリソースの変更を監視
- **Cancel Observation**: 監視を停止
- **Notify**: クライアントがリソースの変更をサーバーに通知
- **Send**（LwM2M 1.1以降）: クライアントが明示的なリクエストなしにデータを送信

通知属性（Notification Attributes）を設定することで、通知の頻度や条件を制御できます。

- **pmin/pmax**: 最小/最大通知間隔
- **gt/lt/st**: 閾値ベースの通知条件
- **edge**（LwM2M 1.2）: 立ち上がり/立ち下がりエッジでの通知

## CoAPプロトコル

LwM2MはCoAP（Constrained Application Protocol）をベースにしています。CoAPはRFC 7252で定義されたプロトコルで、HTTPに似たRESTful設計でありながら、リソース制約のあるデバイス向けに最適化されています。

[https://datatracker.ietf.org/doc/html/rfc7252:embed:cite]

### CoAPの特徴

CoAPには以下のような特徴があります。

- **軽量ヘッダー**: 最小4バイトのヘッダーサイズ
- **UDPベース**: TCPのオーバーヘッドを回避（LwM2M 1.1以降はTCPもサポート）
- **RESTfulメソッド**: GET、PUT、POST、DELETEに対応
- **Observeパターン**: Pub/Subライクなリソース監視
- **Block-wise Transfer**: 大きなペイロードの分割転送

Block-wise Transferの詳細は以下を参照ください。

[https://datatracker.ietf.org/doc/html/rfc7959:embed:cite]

### LwM2M操作とCoAPメソッドの対応

LwM2Mの操作はCoAPメソッドにマッピングされます。

| LwM2M操作 | CoAPメソッド                          |
| --------- | ------------------------------------- |
| Read      | GET                                   |
| Write     | PUT/POST                              |
| Execute   | POST                                  |
| Create    | POST                                  |
| Delete    | DELETE                                |
| Discover  | GET (Accept: application/link-format) |

## オブジェクトモデル

LwM2Mでは、デバイスの情報と機能を **リソースモデル** として構造化しています。このモデルは3階層で構成されています。

### 階層構造

以下の図は、LwM2Mのリソースモデルを簡略化したものです。

```
Object (オブジェクト)
└── Object Instance (オブジェクトインスタンス)
    └── Resource (リソース)
        └── Resource Instance (リソースインスタンス) ※Multiple Resourceの場合
```

各階層の説明は以下の通りです。

- **Object**: デバイスの機能やコンポーネントを表す（例: Device、Firmware Update）
- **Object Instance**: オブジェクトの個別のインスタンス（複数のセンサーがある場合など）
- **Resource**: データや操作の最小単位（例: 製造者名、再起動コマンド）
- **Resource Instance**: Multiple Resourceの場合の個別値

### パス表記

リソースへのアクセスは `/ObjectID/InstanceID/ResourceID` というパス形式で指定します。

例えば、1つ目のデバイスインスタンスの再起動（Reboot）リソースにアクセスする場合は以下のようになります。

- Object: Device（ObjectID = 3）
- Object Instance: 0（1つ目のインスタンス）
- Resource: Reboot（ResourceID = 4）
- パス: `/3/0/4`

### Core Objects

LwM2Mには、すべてのクライアントがサポートすべき（またはサポートを推奨される）コアオブジェクトが定義されています。

| ObjectID | 名前                    | 説明                                           | 必須 |
| -------- | ----------------------- | ---------------------------------------------- | ---- |
| 0        | LwM2M Security          | サーバー接続のセキュリティ情報（機密）         | 必須 |
| 1        | LwM2M Server            | サーバー接続の非機密情報                       | 必須 |
| 2        | Access Control          | オブジェクトへのアクセス制御                   | 任意 |
| 3        | Device                  | デバイスの基本情報（製造者、シリアル番号など） | 必須 |
| 4        | Connectivity Monitoring | 接続状態の監視（信号強度など）                 | 任意 |
| 5        | Firmware Update         | ファームウェア更新の管理                       | 任意 |
| 6        | Location                | 地理的位置情報                                 | 任意 |

各オブジェクトの詳細定義はGitHubで管理されています。例えば、Firmware Updateオブジェクト（ObjectID: 5）の定義は以下です。

[https://github.com/OpenMobileAlliance/lwm2m-registry/blob/prod/5.xml:embed:cite]

### オブジェクトレジストリ

OMA SpecWorksは、標準化されたオブジェクト定義を公開しています。

[https://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html:embed:cite]

このレジストリには、スマートメーター、環境センサー、車両テレマティクスなど、さまざまな業界向けのオブジェクト定義が登録されています。独自のオブジェクトを定義して登録することも可能です。オブジェクト登録のガイドラインは以下です。

[https://github.com/OpenMobileAlliance/lwm2m-registry:embed:cite]

## データエンコーディング

LwM2Mでは、リソースのデータを効率的に転送するために複数のエンコーディング形式をサポートしています。詳細は仕様書の「7.4. Data Formats」セクションに記載されています。

[https://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Core-V1_2-20201110-A.html#7-4-Data-Formats-for-Transferring-Resource-Information:embed:cite]

### サポートされる形式

以下の形式がサポートされています。

- **Plain Text**: 単純なテキスト形式（単一リソース向け）
- **Opaque**: バイナリデータ
- **TLV（Type-Length-Value）**: LwM2M独自のバイナリ形式、コンパクトで効率的
- **JSON**: 人間が読みやすい形式、デバッグに有用
- **SenML JSON**: センサーデータ向けのJSON拡張（LwM2M 1.1以降）
- **SenML CBOR**: SenMLのバイナリ版、より効率的（LwM2M 1.1以降）
- **LwM2M CBOR**: LwM2M 1.2で追加された最適化形式

SenML（Sensor Measurement Lists）の仕様はRFC8428で定義されています。

[https://datatracker.ietf.org/doc/html/rfc8428:embed:cite]

CBOR（Concise Binary Object Representation）の仕様はRFC8949で定義されています。

[https://datatracker.ietf.org/doc/html/rfc8949:embed:cite]

### 選択の指針

選択の指針は以下の通りです。

- **帯域幅が限られている場合**: TLVまたはLwM2M CBOR
- **デバッグや開発時**: JSONまたはSenML JSON
- **センサーデータの時系列転送**: SenML形式
- **最高の効率が必要な場合**: LwM2M CBOR（1.2以降）

## セキュリティ

IoTデバイスの管理では、セキュリティが極めて重要です。LwM2Mは複数のセキュリティメカニズムをサポートしています。詳細はTransport仕様書に記載されています。

[https://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Transport-V1_2-20201110-A.html:embed:cite]

### トランスポート層セキュリティ

トランスポート層では以下のプロトコルがサポートされています。

- **DTLS（Datagram TLS）**: UDP通信の暗号化
  - https://datatracker.ietf.org/doc/html/rfc6347
- **TLS**: TCP通信の暗号化
  - https://datatracker.ietf.org/doc/html/rfc8446
- **DTLS 1.3 / TLS 1.3**: LwM2M 1.2以降でサポート

### セキュリティモード

LwM2Mでは以下のセキュリティモードが定義されています。

- **NoSec**: セキュリティなし（開発・テスト用途のみ推奨）
- **PSK（Pre-Shared Key）**: 事前共有鍵による認証
- **RPK（Raw Public Key）**: 公開鍵による認証
- **Certificate**: X.509証明書による認証

### アプリケーション層セキュリティ

LwM2M 1.1以降では、**OSCORE**（Object Security for Constrained RESTful Environments）によるアプリケーション層セキュリティもサポートしています。これにより、プロキシを経由する場合やstore-and-forward方式でも、エンドツーエンドのセキュリティを確保できます。

[https://datatracker.ietf.org/doc/html/rfc8613:embed:cite]

### Connection ID

LwM2M 1.2では、**DTLS Connection ID**がサポートされています。これにより、NAT越えやIPアドレス変更時でもセッションを維持でき、モバイルデバイスのバッテリー消費を削減できます。

[https://datatracker.ietf.org/doc/html/rfc9146:embed:cite]

## MQTTとの比較

IoTプロトコルとして、MQTTとLwM2Mはよく比較されます。それぞれ異なる目的で設計されており、適切な場面で使い分けることが重要です。

MQTTの仕様は以下で公開されています。

[https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html:embed:cite]

MQTTとLwM2Mの比較については、以下の記事が参考になります。

[https://friendly-tech.com/lwm2m-mqtt-comparison/:embed:cite]

### アーキテクチャの違い

以下の図は、MQTTとLwM2Mのアーキテクチャの違いを整理したものです。

| 項目               | MQTT                       | LwM2M                            |
| ------------------ | -------------------------- | -------------------------------- |
| モデル             | Pub/Sub（ブローカー経由）  | クライアント-サーバー（RESTful） |
| データ構造         | 任意（トピックベース）     | 標準化されたオブジェクトモデル   |
| デバイス管理       | 標準なし（独自実装が必要） | 標準で定義                       |
| ファームウェア更新 | 標準なし                   | 標準オブジェクトで定義           |
| セキュリティ       | TLS/SSL                    | DTLS/TLS + OSCORE                |

### 使い分けの指針

使い分けの指針は以下の通りです。

- **MQTT**: 多対多のメッセージング、リアルタイムデータストリーミング、既存のMQTTインフラがある場合
- **LwM2M**: デバイス管理が必要、ファームウェア更新が必要、標準化されたデータモデルが必要、リソース制約の厳しいデバイス

### LwM2M 1.2でのMQTTサポート

LwM2M 1.2ではMQTTをトランスポートとして使用できるようになりました。これにより、既存のMQTTインフラを活用しながら、LwM2Mのデバイス管理機能を利用することが可能になっています。MQTTバインディングの詳細はTransport仕様書の「4. LwM2M over MQTT」セクションに記載されています。

[https://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Transport-V1_2-20201110-A.html#4-LwM2M-over-MQTT:embed:cite]

## 実装例

### SORACOM Inventoryでの利用

SORACOMが提供するSORACOM Inventoryは、LwM2Mベースのデバイス管理サービスです。

[https://soracom.jp/services/inventory/:embed:cite]

SORACOM InventoryではLwM2Mを使用して以下のような機能を提供しています。

- デバイスのリモート監視と制御
- ファームウェアの無線アップデート（FOTA）
- リモートシェル機能
- デバイスのグループ管理

SORACOMプラットフォームとデバイスをLwM2Mで接続することで、エージェントを介してデバイスのデータや状態を取得したり、リモートで操作を実行したりできます。開発者向けドキュメントは以下です。

[https://users.soracom.io/ja-jp/docs/inventory/:embed:cite]

### その他のプラットフォーム

LwM2Mをサポートする主要なIoTプラットフォームには以下があります。

- **AVSystem Coiote**: エンタープライズ向けデバイス管理
  - https://www.avsystem.com/products/coiote-iot-device-management-platform/
  - https://iotdevzone.avsystem.com/docs/academy/
- **Cumulocity IoT**: マルチプロトコル対応IoTプラットフォーム
  - https://cumulocity.com/docs/protocol-integration/lwm2m/
- **1NCE OS**: セルラーIoT向けプラットフォーム
  - https://help.1nce.com/dev-hub/docs/1nce-os-lwm2m

## さいごに

LwM2Mは、IoTデバイス管理において標準化されたアプローチを提供するプロトコルです。特に以下の点で強みを発揮します。

- 標準化されたオブジェクトモデルによる相互運用性
- ファームウェア更新やリモート診断などのデバイスライフサイクル管理
- リソース制約のあるデバイス向けの効率的な設計
- 堅牢なセキュリティメカニズム

OMA SpecWorksのレジストリには多くの標準オブジェクトが登録されており、SORACOM InventoryのようなプラットフォームではLwM2Mを意識せずに利用できる環境も整っています。

IoTデバイス管理の標準化に興味がある方は、ぜひLwM2Mを検討してみてください。実際にデバイスを接続して動作を確認することで、プロトコルの理解がより深まると思います。
